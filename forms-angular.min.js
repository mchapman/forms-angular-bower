/*! forms-angular 2013-11-14 */
"use strict";function ngGridCsvExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.init=function(c,d){function e(){var a=angular.element("h1").parent(),c=angular.element("#csv-data-link");null!=c&&c.remove();var d='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';d+=encodeURIComponent(b.prepareCSV()),d+='" download="Export.csv">CSV Export</button>',a.append(d)}b.grid=d,b.scope=c,a.inhibitButton||(setTimeout(e,0),c.catHashKeys=function(){var a="";for(var b in c.renderedRows)a+=c.renderedRows[b].$$hashKey;return a},c.$watch("catHashKeys()",e))},b.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(b.prepareCSV()))},b.prepareCSV=function(){function a(a){return null==a?"":"number"==typeof a?""+a:"boolean"==typeof a?a?"TRUE":"FALSE":"string"==typeof a?a.replace(/"/g,'""'):JSON.stringify(a).replace(/"/g,'""')}function c(a){var b=a.substr(0,a.length-1);return b+"\n"}var d="";return angular.forEach(b.scope.columns,function(b){b.visible&&(d+='"'+a(b.displayName)+'",')}),d=c(d),angular.forEach(b.grid.filteredRows,function(e){angular.forEach(b.scope.columns,function(b){b.visible&&(d+='"'+a(e.entity[b.field])+'",')}),d=c(d)}),d}}function ngGridPdfExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.services=null,b.options=a,b.init=function(c,d,e){if(b.grid=d,b.scope=c,b.services=e,!a.inhibitButton){var f=d.$root.find(".ngFooterPanel"),g=d.$root.find(".ngFooterPanel .pdf-data-link-span");null!=g&&g.remove();var h='<button class="pdf-data-link-span">PDF Export</button>';f.append(h),f.on("click",function(){b.createPDF()})}},b.createPDF=function(){var a=[],c=[],d={},e=b.scope.totalRowWidth();angular.forEach(b.scope.columns,function(c){c.visible&&(a.push({name:c.field,prompt:c.displayName,width:c.width*(185/e),align:c.colDef.align||"left"}),c.colDef.totalsRow&&(d[c.field]=b.scope.getTotalVal(c.field,c.filter)))}),angular.forEach(b.grid.filteredRows,function(a){c.push(angular.copy(a.entity))});var f=new jsPDF;f.cellInitialize(),f.table(c,a,d,{printHeaders:!0,autoSize:!1,autoStretch:!1}),f.output("dataurlnewwindow")}}var formsAngular=angular.module("formsAngular",["ngRoute","ngSanitize","ui.select2","ui.date","fng.ui.bootstrap","ui.bootstrap","ngGrid","infinite-scroll","monospaced.elastic"]);formsAngular.controller("AnalysisCtrl",["$locationParse","$filter","$scope","$http","$location","$routeParams",function(a,b,c,d,e,f){var g=!0,h=new ngGridPdfExportPlugin({inhibitButton:!0}),i=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(c,f),c.reportSchema={},c.gridOptions={columnDefs:"reportSchema.columnDefs",data:"report",showColumnMenu:!0,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[h,i],afterSelectionChange:function(a){var b=c.reportSchema.drilldown;b&&(b=b.replace(/!.+?!/g,function(b){var d=b.slice(1,-1),e=/\((.+)\)/.exec(d);return e?c.reportSchema.params[e[1]].value:a.entity[d]}),window.location=b)},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},c.report=[],!c.reportSchemaName&&f.r)switch(f.r.slice(0,1)){case"[":c.reportSchema.pipeline=JSON.parse(f.r);break;case"{":angular.extend(c.reportSchema,JSON.parse(f.r));break;default:throw new Error("No report instructions specified")}c.getTotalVal=function(a,d){var e="",f=_.find(c.reportSchema.columnDefs,function(b){return b.field===a});if(f)switch(f.totalsRow){case void 0:break;case"$SUM":for(var g=0,h=0;h<c.report.length;h++)g+=c.report[h][a];e=g,d&&(e=b(d)(e));break;default:e=f.totalsRow}return e},c.$on("exportToPDF",function(){h.createPDF()}),c.$on("exportToCSV",function(){i.createCSV()}),c.refreshQuery=function(){var a="/api/report/"+c.model,f="?";if(c.reportSchemaName&&(a+="/"+c.reportSchemaName),c.paramSchema){for(var h in c.record)if(c.record.hasOwnProperty(h)){var i=c.reportSchema.params[h];if(c.record[h]&&""!==c.record[h])c.param=c.record[h],i.conversionExpression&&(c.param=c.$eval(i.conversionExpression)),a+=f+h+"="+c.param,f="&";else if(i.required)return}}else{var j=e.$$url.match(/\?.*/);j&&(a+=f+j[0].slice(1))}d.get(a).success(function(a){if(a.success){if(c.report=a.report,c.reportSchema=a.schema,c.reportSchema.title=c.reportSchema.title||c.model,g&&(g=!1,c.$watch("reportSchema.columnDefs",function(a){var b=!1;if(a)for(var d=0;d<a.length;d++)if(a[d].totalsRow&&(b=!0),a[d].align){var e="fng-"+a[d].align;a[d].cellClass=a[d].cellClass||"",-1===a[d].cellClass.indexOf(e)&&(a[d].cellClass=a[d].cellClass+" "+e)}c.gridOptions.showTotals=b,c.gridOptions.reallyShowFooter=b,c.gridOptions.footerRowHeight=55+(b?10:0)},!0),!c.paramSchema&&a.schema.params)){c.paramSchema=[],c.record={};for(var d in a.schema.params)if(a.schema.params.hasOwnProperty(d)){var e=a.schema.params[d];if(!e.noInput){var f=c.paramSchema.push({name:d,id:"fp_"+d,label:e.label||b("titleCase")(d),type:e.type||"text",required:!0,add:e.add||void 0,size:e.size||"small"});"select"===e.type&&(c[d+"_Opts"]=e.enum,c.paramSchema[f-1].options=d+"_Opts")}c.record[d]=e.value}c.$watch("record",function(a,b){b!==a&&c.refreshQuery()},!0)}}else console.log(JSON.stringify(a)),c.reportSchema.title="Error - see console log"}).error(function(a){console.log(JSON.stringify(a)),e.path("/404")})},c.refreshQuery()}]),formsAngular.controller("BaseCtrl",["$scope","$routeParams","$location","$http","$filter","$data","$locationParse","$dialog",function(a,b,c,d,e,f,g,h){function i(a,b,c){var d="#"+(c?"cg_":"")+b;a?$(d).removeClass(q):$(d).addClass(q)}function j(){var c="?l="+a.page_size,d=function(a,b){b&&""!==b&&(c+="&"+a+"="+b)};return d("f",b.f),d("a",b.a),d("o",b.o),d("s",a.pages_loaded*a.page_size),a.pages_loaded++,c}function k(a){var b=a.split("."),c=[b[0]];return b.length>1&&c.push(b.slice(1).join(".")),c}function l(a,b,c){var d=k(a);if(d.length>1)m(d[1],b[d[0]],c);else if(b[d[0]]){var e=b[d[0]];b[d[0]]=c("Object"==typeof e?e.x||e.id:e)}}function m(a,b,c){if(void 0!==b)if($.isArray(b))for(var d=0;d<b.length;d++)l(a,b[d],c);else l(a,b,c)}function n(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push({x:G(b[f],d,c,a.name)});return e}return G(b,d,c,a.name)}function o(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push(H(b[f],c,d,a.name));return e}return H(b,c,d,a.name)}var p={},q="fng-invalid-required",r=f,s=!0;a.record=r.record,a.phase="init",a.disableFunctions=r.disableFunctions,a.dataEventFunctions=r.dataEventFunctions,a.formSchema=[],a.panes=[],a.listSchema=[],a.recordList=[],a.dataDependencies={},a.select2List=[],a.page_size=20,a.pages_loaded=0,angular.extend(a,g(c.$$path)),a.formPlusSlash=a.formName?a.formName+"/":"",a.modelNameDisplay=r.modelNameDisplay||e("titleCase")(a.modelName),a.getId=function(a){return a._id},a.walkTree=function(a,b,c){var d,e,f=b.split("."),g=f.length-1,h=a;c&&(e=c.context.id);for(var i=0;g>i;i++)h=h[f[i]],angular.isArray(h)&&(d=new RegExp(f[i]+"-([0-9])-"+f[i+1]),h=h[parseInt(e.match(d)[1])]);return{lastObject:h,key:f[g]}},a.getData=function(b,c,d){var e=a.walkTree(b,c,d);return e.lastObject[e.key]},a.setData=function(b,c,d,e){var f=a.walkTree(b,c,d);f.lastObject[f.key]=e};var t=function(a,b){return a.id.replace(/\./g,"_")+b},u=function(b,e,f){var g;if(e.caster&&(b.array=!0,e=e.caster,$.extend(f,e.options)),"String"==e.instance){if(f.enum)b.type="select",f.required&&(a.$watch("record."+b.name,function(a){i(a,b.id,b.select2)},!0),setTimeout(function(){i(a.record[b.name],b.id,b.select2)},0)),b.select2?(a["select2"+b.name]={allowClear:!f.required,initSelection:function(a,b){var c=a.val(),d={id:c,text:c};b(d)},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),d=0;d<f.enum.length;d++)-1!==f.enum[d].toUpperCase().indexOf(c)&&b.results.push({id:d,text:f.enum[d]});a.callback(b)}},_.extend(a["select2"+b.name],b.select2),b.select2.s2query="select2"+b.name,a.select2List.push(b.name)):(b.options=t(b,"Options"),a[b.options]=f.enum);else if(!b.type){var h,j;f.form&&(h=f.form.password),j=void 0!==h?h:-1!==b.name.toLowerCase().indexOf("password"),b.type=j?"password":"text"}}else if("ObjectID"==e.instance)b.ref=f.ref,b.link&&b.link.linkOnly?(b.type="link",b.linkText=b.link.text,b.form=b.link.form,delete b.link):(b.type="select",b.select2?(a.select2List.push(b.name),b.select2.fngAjax?(g="ajax"+b.name.replace(/\./g,""),a[g]={allowClear:!f.required,minimumInputLength:2,initSelection:function(e,g){d.get("api/"+f.ref+"/"+e.val()+"/list").success(function(d){d.success===!1&&c.path("/404");var f={id:e.val(),text:d.list};a.setData(p,b.name,e,f),g(f)}).error(function(){c.path("/404")})},ajax:{url:"/api/search/"+f.ref,data:function(a,b){return{q:a,page_limit:10,page:b}},results:function(a){return{results:a.results,more:a.moreCount>0}}}},_.extend(a[g],b.select2),b.select2.fngAjax=g):(1==b.select2&&(b.select2={}),a["select2"+b.name]={allowClear:!f.required,initSelection:function(c,d){var e,f=c.val();e=a[b.options].length>0?H(f,a[b.options],a[b.ids],b.name):f;var g={id:e,text:f};d(g)},query:function(c){for(var d={results:[]},e=c.term.toUpperCase(),f=0;f<a[b.options].length;f++)-1!==a[b.options][f].toUpperCase().indexOf(e)&&d.results.push({id:a[b.ids][f],text:a[b.options][f]});c.callback(d)}},_.extend(a["select2"+b.name],b.select2),b.select2.s2query="select2"+b.name,a.select2List.push(b.name),b.options=t(b,"Options"),b.ids=t(b,"_ids"),I(f.ref,b))):(b.options=t(b,"Options"),b.ids=t(b,"_ids"),I(f.ref,b)));else if("Date"==e.instance)b.type="text",b.add="ui-date ui-date-format ";else if("boolean"==e.instance)b.type="checkbox";else{if("Number"!=e.instance)throw new Error("Field "+b.name+" is of unsupported type "+e.instance);b.type="number"}return f.required&&(b.required=!0),f.readonly&&(b.readonly=!0),b},v=function(a,b,c){return b.name=c+a,b.id=b.id||"f_"+c+a.replace(/\./g,"_"),b.label=null==(b.hasOwnProperty("label")&&b.label)?"":b.label||e("titleCase")(a),b},w=function(a,b,c){var d=b||{hidden:!0};d.hidden||("object"==typeof d?(d.name=c,a.push(d)):a.push({name:c}))},x=function(a,b,c,d){if(c){for(var e=0,f=c.length;f>e;e++)if("text"==c[e].type){b.push({name:c[e].name});break}0===b.length&&0!==c.length&&b.push({name:c[0].name})}if(0===b.length){for(var g in d)if("_id"!==g&&d.hasOwnProperty(g)){b.push({name:g});break}if(0===b.length)throw new Error("Unable to generate a title for "+a)}},y=function(b,c){function d(b){var d=b;return"string"==typeof b&&"$"===b.slice(0,1)&&(d=a.getListData(c,b.slice(1))),d}var e,f=d(b.lhs),g=d(b.rhs);switch(b.comp){case"eq":e=f===g;break;case"ne":e=f!==g;break;default:throw new Error("Unsupported comparator "+b.comp)}return e},z=function(b,c){function d(b){if("string"==typeof b&&"$"===b.slice(0,1)){var d=b.slice(1),f=a.dataDependencies[d]||[];f.push(c),a.dataDependencies[d]=f,e+=1}}var e=0,f=!0;return b&&(d(b.lhs),d(b.rhs),0!==e||y(b)||(f=!1)),f};a.getListData=function(b,c){for(var d=c.split("."),e=0;e<d.length;e++)void 0!==b&&(b=b[d[e]]);return b&&-1!==a.select2List.indexOf(d[e-1])&&(b=b.text),void 0===b&&(b=""),b},a.updateDataDependentDisplay=function(b,c,d){for(var e in a.dataDependencies)if(a.dataDependencies.hasOwnProperty(e)&&(d||b[e]!=c[e]))for(var f=a.dataDependencies[e],g=0;g<f.length;g+=1)for(var h=f[g],i=0;i<a.formSchema.length;i+=1)if(a.formSchema[i].id===h){var j=$("#cg_"+h);y(a.formSchema[i].showIf,b)?j.show():j.hide()}};var A=function(b,c,d,e,f,g){function h(b,c){var d=angular.copy(b),e=_.find(a.panes,function(a){return a.title===d});if(!e){var f=!1;if(0===a.panes.length)if(a.formSchema.length>0){a.panes.push({title:"Main",content:[],active:!0}),e=a.panes[0];for(var g=0;g<a.formSchema.length;g++)e.content.push(a.formSchema[g])}else f=!0;e=a.panes[a.panes.push({title:d,containerType:"pane",content:[],active:f})-1]}e.content.push(c)}for(var i in c)if("_id"!==i&&c.hasOwnProperty(i)){var j=c[i],k=j.options||{},l=k.form||{};if(!l.hidden)if(j.schema){if(g&&d){var m=[];A("Nested "+i,j.schema,m,null,i+".",!0);var n=v(i,l,f);n.schema=m,l.pane&&h(l.pane,n),d.push(n)}}else{if(d){var o=v(i,l,f);if(z(o.showIf,o.id)){var p=u(o,j,k);p.pane&&h(p.pane,p),d.push(p)}}e&&w(e,k.list,i)}}e&&0===e.length&&x(b,e,d,c)};a.readRecord=function(){d.get("api/"+a.modelName+"/"+a.id).success(function(b){b.success===!1&&c.path("/404"),s=!1,"function"==typeof a.dataEventFunctions.onAfterRead&&a.dataEventFunctions.onAfterRead(b),p=E(a.formSchema,b,0),a.phase="ready",a.cancel()}).error(function(){c.path("/404")})},a.scrollTheList=function(){d.get("api/"+a.modelName+j()).success(function(b){a.recordList=a.recordList.concat(b)}).error(function(){c.path("/404")})},d.get("api/schema/"+a.modelName+(a.formName?"/"+a.formName:""),{cache:!0}).success(function(b){A("Main "+a.modelName,b,a.formSchema,a.listSchema,"",!0),a.id||a.newRecord?(a.$watch("record",function(b,c){a.updateDataDependentDisplay(b,c,!1)},!0),a.id?"function"==typeof a.dataEventFunctions.onBeforeRead?a.dataEventFunctions.onBeforeRead(a.id,function(b){b?C(b):a.readRecord()}):a.readRecord():(p={},a.phase="ready",a.cancel())):s=!0}).error(function(){c.path("/404")}),a.cancel=function(){for(var b in a.record)a.record.hasOwnProperty(b)&&delete a.record[b];$.extend(!0,a.record,p),a.dismissError()};var B=function(a,b){if(-1!==[200,400].indexOf(b)){var c="";for(var d in a.errors)if(a.errors.hasOwnProperty(d)){switch(c+="<li><b>"+e("titleCase")(d)+": </b> ",a.errors[d].type){case"enum":c+="You need to select from the list of values";break;default:c+=a.errors[d].message}c+="</li>"}c=c.length>0?a.message+"<br /><ul>"+c+"</ul>":a.message||"Error!  Sorry - No further details available.",C(c)}else C(b+" "+JSON.stringify(a))},C=function(b,c){a.alertTitle=c?c:"Error!",a.errorMessage=b};a.dismissError=function(){delete a.errorMessage},a.createNew=function(b,e){d.post("api/"+a.modelName,b).success(function(b){b.success!==!1?("function"==typeof a.dataEventFunctions.onAfterCreate&&a.dataEventFunctions.onAfterCreate(b),e.redirect?window.location=e.redirect:c.path("/"+a.modelName+"/"+a.formPlusSlash+b._id+"/edit")):C(b)}).error(B)},a.updateDocument=function(b,c){d.post("api/"+a.modelName+"/"+a.id,b).success(function(b){b.success!==!1?("function"==typeof a.dataEventFunctions.onAfterUpdate&&a.dataEventFunctions.onAfterUpdate(b,p),c.redirect?(c.allowChange&&(s=!0),window.location=c.redirect):(p=angular.copy(a.record),a.dismissError())):C(b)}).error(B)},a.save=function(b){b=b||{};var c=F(a.formSchema,angular.copy(a.record),0);a.id?"function"==typeof a.dataEventFunctions.onBeforeUpdate?a.dataEventFunctions.onBeforeUpdate(c,p,function(d){d?C(d):a.updateDocument(c,b)}):a.updateDocument(c,b):"function"==typeof a.dataEventFunctions.onBeforeCreate?a.dataEventFunctions.onBeforeCreate(c,function(d){d?C(d):a.createNew(c,b)}):a.createNew(c,b)},a.new=function(){c.search(""),c.path("/"+a.modelName+"/"+a.formPlusSlash+"new")},a.deleteRecord=function(b,e){d.delete("api/"+b+"/"+e).success(function(){"function"==typeof a.dataEventFunctions.onAfterDelete&&a.dataEventFunctions.onAfterDelete(p),c.path("/"+a.modelName)})},a.$on("$locationChangeStart",function(b,c){s||a.isCancelDisabled()||(h.messageBox("Record modified","Would you like to save your changes?",[{label:"Yes",result:"yes",cssClass:"dlg-yes"},{label:"No",result:"no",cssClass:"dlg-no"},{label:"Cancel",result:"cancel",cssClass:"dlg-cancel"}]).open().then(function(b){switch(b){case"no":s=!0,window.location=c;break;case"yes":a.save({redirect:c,allowChange:!0});case"cancel":}}),b.preventDefault())}),a.delete=function(){var b;if(a.record._id){var c=h.messageBox("Delete Item","Are you sure you want to delete this record?",[{label:"Yes",result:"yes"},{label:"No",result:"no"}]);c.open().then(function(c){"yes"===c&&("function"==typeof a.dataEventFunctions.onBeforeDelete?a.dataEventFunctions.onBeforeDelete(p,function(b){b?C(b):a.deleteRecord(a.modelName,a.id)}):a.deleteRecord(a.modelName,a.id)),"no"===c&&(b=c)}),"no"===b&&c.close()}},a.isCancelDisabled=function(){return"function"==typeof a.disableFunctions.isCancelDisabled?a.disableFunctions.isCancelDisabled(a.record,p,a.myForm):angular.equals(p,a.record)},a.isSaveDisabled=function(){return"function"==typeof a.disableFunctions.isSaveDisabled?a.disableFunctions.isSaveDisabled(a.record,p,a.myForm):a.myForm&&a.myForm.$invalid||angular.equals(p,a.record)},a.isDeleteDisabled=function(){return"function"==typeof a.disableFunctions.isDeleteDisabled?a.disableFunctions.isDeleteDisabled(a.record,p,a.myForm):!1},a.isNewDisabled=function(){return"function"==typeof a.disableFunctions.isNewDisabled?a.disableFunctions.isNewDisabled(a.record,p,a.myForm):!1},a.disabledText=function(b){var c="";return a.isSaveDisabled&&(c="This button is only enabled when the form is complete and valid.  Make sure all required inputs are filled in. "+b),c},a.add=function(b){var c,d=b.split(".");c=a.record;for(var e=0,f=d.length;f>e;e++)c[d[e]]||(c[d[e]]=e===f-1?[]:{}),c=c[d[e]];c.push({})},a.remove=function(b,c){for(var d=b.split("."),e=a.record,f=0,g=d.length;g>f;f++)e=e[d[f]];e.splice(c,1)};var D=function(a){var b=!1;return"text"===a.type?b=!0:"select"!==a.type||a.ids||(b=!0),b},E=function(b,c,d){for(var e=0;e<b.length;e++){var f=b[e].name.slice(d);if(b[e].schema){if(c[f])for(var g=0;g<c[f].length;g++)c[f][g]=E(b[e].schema,c[f][g],d+1+f.length)}else{var h=a.getListData(c,f);if(b[e].array&&D(b[e])&&h)for(var i=0;i<h.length;i++)h[i]={x:h[i]};var j=a[t(b[e],"_ids")];j&&j.length>0&&c[f]?c[f]=n(b[e],c[f],a[t(b[e],"Options")],j):b[e].select2&&!b[e].select2.fngAjax&&c[f]&&a[b[e].select2.s2query].query({term:c[f],callback:function(a){a.results.length>0&&(c[f]=a.results[0])}})}}return c},F=function(b,c,d){for(var e=0;e<b.length;e++){var f=b[e].name.slice(d),g=a.getListData(c,f);if(b[e].schema){if(g)for(var h=0;h<g.length;h++)g[h]=F(b[e].schema,g[h],d+1+f.length)}else{if(b[e].array&&D(b[e])&&g)for(var i=0;i<g.length;i++)g[i]=g[i].x;var j=a[t(b[e],"_ids")];if(j&&j.length>0)l(f,c,function(c){return o(b[e],c,a[t(b[e],"Options")],j)});else if(b[e].select2){var k=a.getData(c,f,null);b[e].select2.fngAjax?k&&a.setData(c,f,null,k.id):k?a.setData(c,f,null,k.text):a.setData(c,f,null,void 0)}}}return c},G=function(a,b,c,d){var e=b.indexOf(a);if(-1===e)throw new Error("convertIdToListValue: Invalid data - id "+a+" not found in "+b+" processing "+d);return c[e]},H=function(a,b,c,d){var e=_.isObject(a)?a.x||a.text:a;if(e&&e.match(/^[0-9a-f]{24}$/))return e;var f=b.indexOf(e);if(-1===f)throw new Error("convertListValueToId: Invalid data - value "+e+" not found in "+b+" processing "+d);return c[f]},I=function(b,c){var e=a[c.options]=[],f=a[c.ids]=[];d.get("api/schema/"+b,{cache:!0}).success(function(a){var g=[];A("Lookup "+b,a,null,g,"",!1),d.get("api/"+b,{cache:!0}).success(function(a){if(a){for(var b=0;b<a.length;b++){for(var d="",h=0;h<g.length;h++)d+=a[b][g[h].name]+" ";d=d.trim();var i=_.sortedIndex(e,d);e.splice(i,0,d),f.splice(i,0,a[b]._id)}J(c)}})})},J=function(b){(angular.equals(p[b.name],a.record[b.name])||b.select2&&a.record[b.name]&&angular.equals(p[b.name],a.record[b.name].text))&&(l(b.name,p,function(c){return n(b,c,a[t(b,"Options")],a[t(b,"_ids")])}),p[b.name]&&(a.record[b.name]=p[b.name]))};a.openSelect2=function(a){$("#"+$(a.currentTarget).data("select2-open")).select2("open")}}]),formsAngular.controller("ModelCtrl",["$scope","$http","$location",function(a,b,c){a.models=[],b.get("api/models").success(function(b){a.models=b}).error(function(){c.path("/404")})}]),formsAngular.controller("NavCtrl",["$scope","$data","$location","$filter","$locationParse","$controller",function(a,b,c,d,e,f){function g(b,c){var d,e={};b+="Ctrl",e.$scope=a.scopes[c]=a.$new();try{f(b,e),d=a.routing.newRecord?"creating":a.routing.id?"editing":"listing",angular.isObject(e.$scope.contextMenu)&&angular.forEach(e.$scope.contextMenu,function(b){b[d]&&a.items.push(b)})}catch(g){/is not a function, got undefined/.test(g.message)||console.log("Unable to instantiate "+b+" - "+g.message)}}a.items=[],a.$on("$locationChangeSuccess",function(){if(a.routing=e(c.$$path),a.items=[],a.routing.analyse)a.contextMenu="Report",a.items=[{broadcast:"exportToPDF",text:"PDF"},{broadcast:"exportToCSV",text:"CSV"}];else if(a.routing.modelName){angular.forEach(a.scopes,function(a){a.$destroy()}),a.scopes=[],b.record={},b.disableFunctions={},b.dataEventFunctions={},delete b.dropDownDisplay,delete b.modelNameDisplay;var f=d("titleCase")(a.routing.modelName,!0);g(f,0),a.routing.formName&&g(f+d("titleCase")(a.routing.formName,!0),1),a.contextMenu=b.dropDownDisplay||b.modelNameDisplay||d("titleCase")(a.routing.modelName,!1)}}),a.doClick=function(b){if(a.items[b].broadcast)a.$broadcast(a.items[b].broadcast);else{var c=a.items[b].args||[],d=a.items[b].fn;switch(c.length){case 0:d();break;case 1:d(c[0]);break;case 2:d(c[0],c[1]);break;case 3:d(c[0],c[1],c[2]);break;case 4:d(c[0],c[1],c[2],c[3])}}}}]),formsAngular.controller("SearchCtrl",["$scope","$http",function(a,b){a.results=[],a.moreCount=0,a.$watch("searchTarget",function(c){c&&c.length>0?b.get("api/search?q="+c).success(function(b){a.results=b.results,a.moreCount=b.moreCount,a.errorClass=0===a.results.length?"error":""}).error(function(a,b){console.log("Error in searchbox.js : "+a+" (status="+b+")")}):(a.errorClass="",a.results=[])},!0),a.$on("$routeChangeStart",function(){a.searchTarget=""})}]),angular.module("fng.ui.bootstrap",["fng.ui.bootstrap.tpls","fng.ui.bootstrap.dropdownToggle","fng.ui.bootstrap.tabs"]),angular.module("fng.ui.bootstrap.tpls",["template/tabs/pane.html","template/tabs/tabs.html"]),angular.module("fng.ui.bootstrap.dropdownToggle",[]).directive("dropdownToggle",["$document","$location","$window",function(a){var b=null,c=angular.noop;return{restrict:"CA",link:function(d,e){d.$watch("$location.path",function(){c()}),e.parent().bind("click",function(){c()}),e.bind("click",function(d){d.preventDefault(),d.stopPropagation();var f=e===b;b&&c(),f||(e.parent().addClass("open"),b=e,c=function(d){d&&(d.preventDefault(),d.stopPropagation()),a.unbind("click",c),e.parent().removeClass("open"),c=angular.noop,b=null},a.bind("click",c))})}}}]),angular.module("fng.ui.bootstrap.tabs",[]).controller("TabsController",["$scope","$element",function(a){var b=a.panes=[];this.select=a.select=function(a){angular.forEach(b,function(a){a.selected=!1}),a.selected=!0},this.addPane=function(c){b.length||a.select(c),b.push(c)},this.removePane=function(c){var d=b.indexOf(c);b.splice(d,1),c.selected&&b.length>0&&a.select(b[d<b.length?d:d-1])}}]).directive("tabs",function(){return{restrict:"EA",transclude:!0,scope:{},controller:"TabsController",templateUrl:"template/tabs/tabs.html",replace:!0}}).directive("pane",["$parse",function(a){return{require:"^tabs",restrict:"EA",transclude:!0,scope:{heading:"@"},link:function(b,c,d,e){var f,g;b.selected=!1,d.active&&(f=a(d.active),g=f.assign,b.$watch(function(){return f(b.$parent)},function(a){b.selected=a}),b.selected=f?f(b.$parent):!1),b.$watch("selected",function(a){a&&e.select(b),g&&g(b.$parent,a)}),e.addPane(b),b.$on("$destroy",function(){e.removePane(b)})},templateUrl:"template/tabs/pane.html",replace:!0}}]),angular.module("template/tabs/pane.html",[]).run(["$templateCache",function(a){a.put("template/tabs/pane.html",'<div class="tab-pane" ng-class="{active: selected}" ng-show="selected" ng-transclude></div>')}]),angular.module("template/tabs/tabs.html",[]).run(["$templateCache",function(a){a.put("template/tabs/tabs.html",'<div class="tabbable">  <ul class="nav nav-tabs">    <li ng-repeat="pane in panes" ng-class="{active:pane.selected}">      <a ng-click="select(pane)">{{pane.heading}}</a>    </li>  </ul>  <div class="tab-content" ng-transclude></div></div>')}]),formsAngular.directive("formButtons",["$compile",function(a){return{restrict:"A",compile:function(){return function(b,c){var d='<div class="btn-group pull-right"><button id="saveButton" class="btn btn-mini btn-primary form-btn" ng-click="save()" ng-disabled="isSaveDisabled()"><i class="icon-ok"></i> Save</button><button id="cancelButton" class="btn btn-mini btn-warning form-btn" ng-click="cancel()" ng-disabled="isCancelDisabled()"><i class="icon-remove"></i> Cancel</button></div><div class="btn-group pull-right"><button id="newButton" class="btn btn-mini btn-success form-btn" ng-click="new()" ng-disabled="isNewDisabled()"><i class="icon-plus"></i> New</button><button id="deleteButton" class="btn btn-mini btn-danger form-btn" ng-click="delete()" ng-disabled="isDeleteDisabled()"><i class="icon-minus"></i> Delete</button></div>';c.replaceWith(a(d)(b))}}}}]),formsAngular.directive("formInput",["$compile","$rootScope","utils",function(a,b,c){return{restrict:"E",compile:function(){return function(d,e,f){function g(a,b){var e="getAddAll"+a+"Options";return c[e](d,f,b)||[]}var h="",i=[],j=!1;d.toggleFolder=function(a){d["showHide"+a]=!d["showHide"+a],$("i."+a).toggleClass("icon-folder-open icon-folder-close")};var k=function(a){return!a||"undefined"===a||"horizontal"===a||"horizontalCompact"===a},l=function(a,b,c,e){if(!b)if(f.subschema&&-1!=a.name.indexOf(".")){var h=a.name,i=h.lastIndexOf(".");f.subkey?(b="record."+h.slice(0,i)+"[$_arrayOffset_"+h.slice(0,i).replace(/\./g,"_")+"_"+f.subkeyno+"]."+h.slice(i+1),e=h+"_subkey"):(b="record."+h.slice(0,i)+"."+d.$index+"."+h.slice(i+1),e=b.slice(7).replace(/\./g,"-"))}else b=(f.model||"record")+"."+a.name;var j,k=c||a.required?" required":"",l=a.readonly?" readonly":"",m=a.placeHolder;"inline"===f.formstyle&&(m=m||a.label);var n='ng-model="'+b+'"'+(e?' id="'+e+'" name="'+e+'" ':" ")+(m?'placeholder="'+m+'" ':"");return n+=g("Field"),"select"===a.type?(n+=a.readonly?"disabled ":"",a.select2?(n+='class="fng-select2'+(a.size?" input-"+a.size:"")+'"',a.select2.fngAjax?(j='<div class="input-append">',j+='<input ui-select2="'+a.select2.fngAjax+'" '+n+">",j+='<button class="btn" type="button" data-select2-open="'+e+'" ng-click="openSelect2($event)"><i class="icon-search"></i></button>',j+="</div>"):a.select2&&(j='<input ui-select2="'+a.select2.s2query+'" '+(a.readonly?"disabled ":"")+n+">")):(j="<select "+n+(a.size?'class="input-'+a.size+'" ':"")+">",c||(j+="<option></option>"),j+='<option ng-repeat="option in '+a.options+'">{{option}}</option>',j+="</select>")):"link"===a.type?j='<a ng-href="/#/'+a.ref+(a.form?"/"+a.form:"")+"/{{ "+b+'}}/edit">'+a.linkText+"</a>":(n+=(a.size?'class="input-'+a.size+'" ':"")+(a.add?a.add:"")+'ng-model="'+b+'"'+(e?' id="'+e+'" name="'+e+'"':"")+k+l+" ","textarea"==a.type?(a.rows&&(n+="auto"==a.rows?'msd-elastic="\n" class="ng-animate" ':'rows = "'+a.rows+'" '),j="<textarea "+n+" />"):(j="<input "+n+'type="'+a.type+'"',"inline"===f.formstyle&&(a.size||(j+=' class="input-small"')),j+=" />")),a.helpInline&&(j+='<span class="help-inline">'+a.helpInline+"</span>"),a.help&&(j+='<span class="help-block">'+a.help+"</span>"),j},m=function(a){switch(a){case"horizontal":return"form-horizontal";case"vertical":return"";case"inline":return"form-inline";case"horizontalCompact":return"form-horizontal compact";default:return"form-horizontal compact"}},n=function(a){var b={before:"",after:""};switch(a.containerType){case"pane":b.before='<pane heading="'+a.title+'" active="'+(a.active||"false")+'">',b.after="</pane>";break;case"tab":b.before="<tabs>",b.after="</tabs>";break;case"well":b.before='<div class="well">',a.title&&(b.before+="<h4>"+a.title+"</h4>"),b.after="</div>";break;case"well-large":b.before='<div class="well well-large">',b.after="</div>";break;case"well-small":b.before='<div class="well well-small">',b.after="</div>";break;case"fieldset":b.before="<fieldset>",a.title&&(b.before+="<legend>"+a.title+"</legend>"),b.after="</fieldset>";break;case"container":b.before="<fieldset>",a.title&&(b.before+="<a ng-click=\"toggleFolder('"+a.id+'\')" class="container-header"><i class="icon-folder-open '+a.id+'"></i>',b.before+=a.title,b.before+='</a><i class="icon-plus-sign"></i>'),r(a.content,null,a.id),b.after="</fieldset>";break;case void 0:break;case null:break;case"":break;default:if(b.before='<div class="'+a.containerType+'">',a.title){var c=a.titleTagOrClass||"h4";b.before+=c.match(/h[1-6]/)?"<"+c+">"+a.title+"</"+a.titleLook+">":'<p class="'+c+'">'+a.title+"</p>"}b.after="</div>"}return b},o=function(a,b){var c="";return("inline"!==f.formstyle&&""!==a.label||b)&&(c="<label",k(f.formstyle)&&(c+=' for="'+a.id+'"'+g("Label","control-label")),c+=">"+a.label+(b||"")+"</label>"),c},p=function(a,b,c,e,g){d["$_arrayOffset_"+a+"_"+g]=0;var h=n(b),i=h.before;return i+='<form-input schema="'+c+'" subschema="true" formStyle="'+f.formstyle+'" subkey="'+c+'_subkey" subkeyno = "'+g+'"></form-input>',i+=h.after},q=function(a,b){var c=b?' ui-toggle="showHide'+b+'"':"",e=k(f.formstyle),h=e?"<div"+g("Group","control-group")+c+' id="cg_'+a.id+'">':"<span "+c+' id="cg_'+a.id+'">';if(a.schema){var j=a.name.replace(/\./g,"_"),n="$_schema_"+j;if(d[n]=a.schema,a.subkey){if(a.subkey.path=a.name,d[n+"_subkey"]=a.subkey,angular.isArray(a.subkey))for(var q=0;q<a.subkey.length;q++)h+=p(j,a.subkey[q],n,a,q);else h+=p(j,a.subkey,n,a,"0");i.push(a)}else h+='<div class="schema-head">'+a.label+'</div><div ng-form class="'+m(a.formStyle)+'" name="form_'+j+'{{$index}}" class="sub-doc well" id="'+a.id+'List_{{$index}}" ng-repeat="subDoc in record.'+a.name+' track by $index"><div class="row-fluid sub-doc"><div class="pull-left"><form-input schema="'+n+'" subschema="true" formStyle="'+a.formStyle+'"></form-input></div>',a.noRemove||(h+='<div class="pull-left sub-doc-btns"><button id="remove_'+a.id+'_btn" class="btn btn-mini form-btn" ng-click="remove(\''+a.name+'\',$index)"><i class="icon-minus"></i> Remove</button></div> '),h+='</div></div><div class = "schema-foot">',a.noAdd||(h+='<button id="add_'+a.id+'_btn" class="btn btn-mini form-btn" ng-click="add(\''+a.name+'\')"><i class="icon-plus"></i> Add</button>'),h+="</div>"
}else{var r=k(f.formstyle)?' class="controls"':"";if(a.array){if("inline"===f.formstyle)throw"Cannot use arrays in an inline form";h+=o(a,' <i id="add_'+a.id+'" ng-click="add(\''+a.name+'\')" class="icon-plus-sign"></i>')+"<div "+r+' id="'+a.id+'List" ng-repeat="arrayItem in record.'+a.name+'">'+l(a,"arrayItem.x",!0,a.id+"_{{$index}}")+"<i ng-click=\"remove('"+a.name+'\',$index)" id="remove_'+a.id+'_{{$index}}" class="icon-minus-sign"></i></div>'}else h+=o(a),""!==r&&(h+="<div "+r+">"),h+=l(a,null,f.required,a.id),""!==r&&(h+="</div>")}return h+=e?"</div>":"</span>"},r=function(a,b,c){for(var g=0;g<a.length;g++){var i=a[g];0===g&&b&&!f.schema.match(/$_schema_/)&&(i.add=i.add||"",-1==i.add.indexOf("ui-date")&&(i.add=i.add+"autofocus "));var k=!0;if(i.directive){for(var l=i.directive,m="<"+l,o=e[0],p=0;p<o.attributes.length;p++){var s=o.attributes[p];switch(s.nodeName){case"ng-repeat":break;case"class":var t=s.nodeValue.replace("ng-scope","");t.length>0&&(m+=' class="'+t+'"');break;case"schema":var u=angular.copy(i);delete u.directive;var v=("bespoke_"+i.name).replace(/\./g,"_");m+=' ng-init="'+v+"=["+JSON.stringify(u).replace(/\"/g,"'")+']" schema="'+v+'"';break;default:m+=" "+s.nodeName+'="'+s.nodeValue+'"'}}m+="></"+l+">",h+=m,k=!1}else if(i.containerType){var w=n(i);switch(i.containerType){case"pane":j||(j="forced",h+="<tabs>"),h+=w.before,r(i.content),h+=w.after;break;case"tab":j=!0,h+=w.before,r(i.content),h+=w.after;break;case"container":h+=w.before,r(i.content,null,i.id),h+=w.after;break;default:h+=w.before,r(i.content),h+=w.after}k=!1}else if(f.subkey){var x=angular.isArray(d[f.subkey])?d[f.subkey][0].keyList:d[f.subkey].keyList;_.find(x,function(a,b){return d[f.subkey].path+"."+b===i.name})&&(k=!1)}k&&(c&&(d["showHide"+c]=!0),h+=q(i,c))}},s=d.$watch(f.schema,function(c){if(c&&(angular.isArray(c)||(c=[c]),c.length>0)){if(s(),h="",r(c,!0),"forced"===j&&(h+="</tabs>"),e.replaceWith(a(h)(d)),i.length>0)var f=d.$watch("phase",function(a){if("ready"===a){f();for(var b=0;b<i.length;b++){var c,e,g,h=i[b];g=angular.isArray(h.subkey)?h.subkey:[h.subkey];for(var j=0;j<g.length;j++){var k=g[j].keyList,l=d.record[h.name]=d.record[h.name]||[];for(c=0;c<l.length;c++){e=!0;for(var m in k)if(k.hasOwnProperty(m)&&l[c][m]!==k[m]){e=!1;break}if(e)break}e||(c=d.record[h.name].push(k)-1),d["$_arrayOffset_"+h.name.replace(/\./g,"_")+"_"+j]=c}}}});b.$broadcast("formInputDone"),d.updateDataDependentDisplay&&d.updateDataDependentDisplay(d.record,null,!0)}},!0)}}}}]),formsAngular.directive("hideOnEmpty",function(){return{replace:!1,link:function(a,b,c){b.hasClass("control-group")?(b.find("input").length>0&&void 0===a.$eval(b.find("input").prop("attributes").getNamedItem("ng-model").value)&&b.hide(),b.find("textarea").length>0&&void 0===a.$eval(b.find("textarea").prop("attributes").getNamedItem("ng-model").value)&&b.hide()):void 0===a.$eval(c.ngModel)&&b.hide()}}});var COL_FIELD=/COL_FIELD/g;formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(a,b){var c={scope:!1,compile:function(){return{pre:function(b,c){var d,e,f=b.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);e=f?b.col.cellTemplate.replace("COL_FIELD |"+f[1],'getTotalVal("'+b.col.field+'","'+f[1]+'")'):b.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+b.col.field+'")'),b.col.enableCellEdit?(d=b.col.cellEditTemplate,d=d.replace(DISPLAY_CELL_TEMPLATE,e),d=d.replace(EDITABLE_CELL_TEMPLATE,b.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+b.col.field))):d=e;var g=a(d)(b);b.enableCellSelection&&-1===g[0].className.indexOf("ngSelectionCell")&&(g[0].setAttribute("tabindex",0),g.addClass("ngCellElement")),c.append(g)},post:function(a,c){a.enableCellSelection&&a.domAccessProvider.selectionHandlers(a,c),a.$on("ngGridEventDigestCell",function(){b.digest(a)})}}}};return c}]),formsAngular.filter("titleCase",[function(){return function(a,b){var c=a.replace(/(_|\.)/g," ").replace(/[A-Z]/g," $&").replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()});return b&&(c=c.replace(/\s/g,"")),c}}]),formsAngular.factory("$data",[function(){var a={record:{},disableFunctions:{},dataEventFunctions:{}};return a}]),formsAngular.factory("$locationParse",[function(){var a=null,b={};return function(c){if(c!==a){a=c;var d=c.split("/"),e=d.length;if(2==e&&"index"==d[1])b={index:!0};else if(b={newRecord:!1},"analyse"==d[1])b.analyse=!0,b.modelName=d[2];else{b.modelName=d[1];var f=d[e-1];"new"===f?(b.newRecord=!0,e--):"edit"===f&&(e-=2,b.id=d[e]),e>2&&(b.formName=d[2])}}return b}}]),formsAngular.service("utils",function(){function a(a,b,c,d){function e(a){for(var b in a)b===c&&h.push(a[b]),"$parent"===b&&e(a[b])}var f,g,h=[],i=[];if(c="addAll"+c,"string"==typeof d){f=d.split(" ");for(var j=0;j<f.length;j++)i.push(f[j])}if(e(a),void 0!==b[c])if("object"==typeof b[c]);else if("string"==typeof b[c])for(var f=b[c].split(" "),j=0;j<f.length;j++)0===f[j].indexOf("class=")?i.push(f[j].substring(6,f[j].length)):h.push(f[j]);return d=i.length>0?' class="'+i.join(" ")+'" ':" ",g=h.length>0?h.join(" ")+" ":"",d+g}this.getAddAllGroupOptions=function(b,c,d){return a(b,c,"Group",d)},this.getAddAllFieldOptions=function(b,c,d){return a(b,c,"Field",d)},this.getAddAllLabelOptions=function(b,c,d){return a(b,c,"Label",d)}});